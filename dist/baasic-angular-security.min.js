!function(e){var r=e.module("baasic.security",["baasic.api"]);!function(e,r){"use strict";r.directive("baasicRecaptcha",["baasicRecaptchaService",function(e){return{restrict:"A",link:function(r,t){e.create(t,{theme:"clean"}),r.$on("$destroy",function(){e&&e.destroy()})}}}])}(e,r),function(e,r,t){"use strict";var s={};r.service("baasicAuthorizationService",["$rootScope","baasicApp",function(r,n){var i=n.get(),a=i.getApiKey();return s[a]={},{getUser:function(){var e=i.getUser();return r.user===t&&e.user!==t&&(r.user=e.user),e.user},setUser:function(e){e?(i.setUser(e),e.isAuthenticated=!0,r.user=e):(i.setUser(null),this.resetPermissions(),r.user={isAuthenticated:!1})},updateUser:function(r){var t=this.getUser();t?e.extend(t,r):t=r,this.setUser(t)},getAccessToken:function(){return i.getAccessToken()},updateAccessToken:function(e){return i.updateAccessToken(e)},resetPermissions:function(){s[a]={}},hasPermission:function(e){if(s[a].hasOwnProperty(e))return s[a][e];var r=this.getUser();if(r!==t){var n=!1;if(r.permissions){var i=e.split(".");if(i.length>0){var c=i[0],o=r.permissions[c];if(o)if(i.length>1){for(var u=i[1].toLowerCase(),f=0;f<o.length;f++)if(o[f].toLowerCase()===u){n=!0;break}}else n=!0}}return s[a][e]=n,n}}}}])}(e,r),function(e,r){"use strict";r.service("baasicPermissionsRouteService",["baasicUriTemplateService",function(e){return{find:function(r){return e.parse("permissions/sections/{section}/{?searchQuery,sort}",r)},getActions:e.parse("permissions/actions/{?searchQuery,sort}"),getRoles:e.parse("roles/{?searchQuery,page,rpp,sort}"),getUsers:e.parse("users/{?searchQuery,page,rpp,sort}"),create:e.parse("permissions/"),parse:e.parse}}])}(e,r),function(e,r,t){"use strict";r.service("baasicPermissionsService",["$q","$filter","baasicApiHttp","baasicApiService","baasicConstants","baasicPermissionsRouteService","baasicAuthorizationService",function(r,s,n,i,a,c,o){function u(e){return e===t||null===e||""===e}function f(e){return n.get(c.getRoles.expand(i.findParams(e)))}function p(e){return n.get(c.getUsers.expand(i.findParams(e)))}function m(e){return e.replace(/^./,function(e){return e.toLowerCase()})}var d=s("orderBy");return{routeService:c,find:function(r,t){var s=e.extend({},t);return s.section=r,n.get(c.find().expand(i.findParams(s)))},getActions:function(e){return n.get(c.getActions.expand(i.findParams(e)))},getPermissionSubjects:function(s){function n(){a++,2===a&&(c.resolve(i),a=0)}var i=[],a=0,c=r.defer();return p(s).success(function(r){e.forEach(r.item,function(r){var t={name:r.userName,role:""};e.extend(t,r),i.push(t)}),n()}).error(function(e,r,s,i){r!==t&&403!==r&&c.reject({data:e,status:r,headers:s,config:i}),n()}),f(s).success(function(r){e.forEach(r.item,function(r){var t={name:r.name,roleName:r.name,userName:""};e.extend(t,r),i.push(t)}),n()}).error(function(e,r,s,i){r!==t&&403!==r&&c.reject({data:e,status:r,headers:s,config:i}),n()}),c.promise.then(function(){return d(i,"name")})},create:function(e){return n.post(c.create.expand(),i.createParams(e)[a.modelPropertyName])},remove:function(e){var r=i.removeParams(e),t=e.actions[0],s=u(e.role)?"User":"Role";return n.delete(r[a.modelPropertyName].links("delete"+t.abrv+s).href)},createPermission:function(r,t,s){var n={dirty:!0,role:s.roleName,userName:s.userName,section:r,actions:[]};return e.forEach(t,function(r){var t={checked:!1};e.extend(t,r),n.actions.push(t)}),n},findPermission:function(e,r){for(var s=0;s<r.length;s++){var n=r[s];if(n.section===e.section&&(!u(n.role)&&!u(e.role)&&n.role===e.role||!u(n.userName)&&!u(e.userName)&&n.userName===e.userName))return n}return t},exists:function(e,r){return this.findPermission(e,r)!==t},togglePermission:function(r,t){var s={};e.extend(s,r),s.actions=[t];var n;return(n=t.checked?this.create:this.remove)(s)},getModulePermissions:function(e){var r={update:o.hasPermission(m(e)+".update"),create:o.hasPermission(m(e)+".create"),remove:o.hasPermission(m(e)+".delete"),read:o.hasPermission(m(e)+".read"),full:o.hasPermission(m(e)+".full")};return r}}}])}(e,r),function(e,r){"use strict";r.service("baasicRecaptchaService",["recaptchaKey",function(e){return{create:function(r,t){var s=r.attr("id");s||(s="recaptcha-"+1e4*Math.random(),r.attr("id",s)),Recaptcha.create(e,s,t)},challenge:function(){return Recaptcha.get_challenge()},response:function(){return Recaptcha.get_response()},reload:function(){Recaptcha.reload()},destroy:function(){Recaptcha.destroy()}}}])}(e,r)}(angular);