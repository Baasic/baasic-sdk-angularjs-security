!function(e){var r=e.module("baasic.security",["baasic.api"]);r.config(["$provide",function(){}]),function(e,r){"use strict";r.directive("baasicRecaptcha",["baasicRecaptchaService",function(e){return{restrict:"A",link:function(r,t){e.create(t,{theme:"clean"}),r.$on("$destroy",function(){e&&e.destroy()})}}}])}(e,r),function(e,r,t){"use strict";var n={};r.service("baasicAuthorizationService",["$rootScope","baasicApp",function(r,s){var i=s.get(),a=i.get_apiKey();return n[a]={},{getUser:function(){var e=i.get_user();return r.user===t&&e.user!==t&&(r.user=e.user),e.user},setUser:function(e){e?(i.set_user(e),e.isAuthenticated=!0,r.user=e):(i.set_user(null),this.resetPermissions(),r.user={isAuthenticated:!1})},updateUser:function(r){var t=this.getUser();t?e.extend(t,r):t=r,this.setUser(t)},getAccessToken:function(){return i.get_accessToken()},updateAccessToken:function(e){return i.update_accessToken(e)},resetPermissions:function(){n[a]={}},hasPermission:function(e){if(n[a].hasOwnProperty(e))return n[a][e];var r=this.getUser();if(r!==t){var s=!1;if(r.permissions){var i=e.split(".");if(i.length>0){var c=i[0],o=r.permissions[c];if(o)if(i.length>1){for(var u=i[1].toLowerCase(),f=0;f<o.length;f++)if(o[f].toLowerCase()==u){s=!0;break}}else s=!0}}return n[a][e]=s,s}}}}])}(e,r),function(e,r){"use strict";r.service("baasicPermissionsRouteService",["baasicUriTemplateService",function(e){return{find:function(){return e.parse("permissions/sections/{section}/{?searchQuery,sort}")},getActions:e.parse("permissions/actions/{?searchQuery,sort}"),getRoles:e.parse("roles/{?searchQuery,page,rpp,sort}"),getUsers:e.parse("users/{?searchQuery,page,rpp,sort}"),create:e.parse("permissions/"),parse:e.parse}}])}(e,r),function(e,r,t){"use strict";r.service("baasicPermissionsService",["$q","$filter","baasicApiHttp","baasicApiService","baasicConstants","baasicPermissionsRouteService","baasicAuthorizationService",function(r,n,s,i,a,c,o){function u(e){return e===t||null===e||""===e}function f(e){return s.get(c.getRoles.expand(i.findParams(e)))}function p(e){return s.get(c.getUsers.expand(i.findParams(e)))}function h(e){return e.replace(/^./,function(e){return e.toLowerCase()})}var m=n("orderBy"),d=n("filter");return{routeService:c,find:function(r,t){var n=e.extend({},t);return n.section=r,s.get(c.find().expand(i.findParams(n)))},getActions:function(e){return s.get(c.getActions.expand(i.findParams(e)))},getPermissionSubjects:function(t){var n=[],s=p(t).success(function(r){e.forEach(r.item,function(r){var t={name:r.userName,role:""};e.extend(t,r),n.push(t)})}),i=f(t).success(function(r){e.forEach(r.item,function(r){var t={name:r.name,roleName:r.name,userName:""};e.extend(t,r),n.push(t)})});return r.all([s,i]).then(function(){return m(n,"name")})},create:function(e){return s.post(c.create.expand(),i.createParams(e)[a.modelPropertyName])},remove:function(e){var r=i.removeParams(e),t=e.actions[0],n=u(e.role)?"User":"Role";return s.delete(r[a.modelPropertyName].links("delete"+t.abrv+n).href)},preparePermissions:function(r,n,s,i){var a=this,c=e.copy(d(i,function(e){return u(r.pagingInfo.search)?!0:e.name.indexOf(r.pagingInfo.search)>-1}));return e.forEach(s,function(r){e.forEach(n,function(t){var n=d(r.actions,function(e){return e.abrv===t.abrv});if(0===n.length){var s={checked:!1};e.extend(s,t),r.actions.push(s)}else e.forEach(n,function(e){e.checked=!0})}),r.actions=m(r.actions,"name");var s=a.findPermission(r,c);s===t?c.push(r):e.extend(s,r)}),c},createPermission:function(r,t,n){var s={dirty:!0,role:n.roleName,userName:n.userName,section:r,actions:[]};return e.forEach(t,function(r){var t={checked:!1};e.extend(t,r),s.actions.push(t)}),s},findPermission:function(e,r){for(var n=0;n<r.length;n++){var s=r[n];if(s.section===e.section&&(!u(s.role)&&!u(e.role)&&s.role===e.role||!u(s.userName)&&!u(e.userName)&&s.userName===e.userName))return s}return t},exists:function(e,r){return!(this.findPermission(e,r)===t)},togglePermission:function(r,t){var n={};e.extend(n,r),n.actions=[t];var s;return(s=t.checked?this.create:this.remove)(n)},getModulePermissions:function(e){var r={update:o.hasPermission(h(e)+".update"),create:o.hasPermission(h(e)+".create"),remove:o.hasPermission(h(e)+".delete"),read:o.hasPermission(h(e)+".read")};return r}}}])}(e,r),function(e,r){"use strict";r.service("baasicRecaptchaService",["recaptchaKey",function(e){return{create:function(r,t){var n=r.attr("id");n||(n="recaptcha-"+1e4*Math.random(),r.attr("id",n)),Recaptcha.create(e,n,t)},challenge:function(){return Recaptcha.get_challenge()},response:function(){return Recaptcha.get_response()},reload:function(){Recaptcha.reload()},destroy:function(){Recaptcha.destroy()}}}])}(e,r)}(angular);