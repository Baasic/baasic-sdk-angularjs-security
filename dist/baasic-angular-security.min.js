/*
 Baasic AngularJS Security v1.0.1
 (c) 2014-2017 Mono Ltd. http://baasic.com
 License: MIT
*/
!function(e){var r=e.module("baasic.security",["baasic.api"]);!function(e,r){"use strict";r.directive("baasicRecaptcha",["baasicRecaptchaService",function(e){return{restrict:"A",link:function(r,t){r.widgetId=e.create(t,{theme:"light"}),r.$on("$destroy",function(){e&&e.destroy(r.widgetId)})}}}])}(e,r),function(e,r,t){"use strict";var n={};r.service("baasicAuthorizationService",["$rootScope","$document","baasicApp",function(r,s,i){var a=i.get(),c=a.getApiKey();return n[c]={},e.element(s).bind("tokenExpired",function(){var e=a.getUser();r.user!==t&&e!==t&&(r.user.isAuthenticated=e.isAuthenticated())}),{getUser:function(){var e=a.getUser();return r.user===t&&e.user!==t&&(r.user=e.user),e.user},setUser:function(e){e?(a.setUser(e),e.isAuthenticated=!0,r.user=e):(a.setUser(null),this.resetPermissions(),r.user={isAuthenticated:!1})},updateUser:function(r){var t=this.getUser();t?e.extend(t,r):t=r,this.setUser(t)},getAccessToken:function(){return a.getAccessToken()},updateAccessToken:function(e){return a.updateAccessToken(e)},resetPermissions:function(){n[c]={}},hasPermission:function(e){if(n[c].hasOwnProperty(e))return n[c][e];var r=this.getUser();if(r!==t){var s=!1;if(r.permissions){var i=e.split(".");if(i.length>0){var a=i[0],o=r.permissions[a];if(o)if(i.length>1){for(var u=i[1].toLowerCase(),f=0;f<o.length;f++)if(o[f].toLowerCase()===u){s=!0;break}}else s=!0}}return n[c][e]=s,s}}}}])}(e,r),function(e,r){"use strict";r.service("baasicPermissionsRouteService",["baasicUriTemplateService",function(e){return{find:function(r){return e.parse("permissions/sections/{section}/{?searchQuery,sort}",r)},getActions:e.parse("permissions/actions/{?searchQuery,sort}"),getRoles:e.parse("lookups/roles/{?searchQuery,page,rpp,sort}"),getUsers:e.parse("users/{?searchQuery,page,rpp,sort}"),create:e.parse("permissions/"),parse:e.parse}}])}(e,r),function(e,r,t){"use strict";r.service("baasicPermissionsService",["$q","$filter","baasicApiHttp","baasicApiService","baasicConstants","baasicPermissionsRouteService","baasicAuthorizationService",function(r,n,s,i,a,c,o){function u(e){return e===t||null===e||""===e}function f(e){return s.get(c.getRoles.expand(i.findParams(e)))}function d(e){return s.get(c.getUsers.expand(i.findParams(e)))}function p(e){return e.replace(/^./,function(e){return e.toLowerCase()})}var m=n("orderBy");return{find:function(r,t){var n=e.extend({},t);return n.section=r,s.get(c.find().expand(i.findParams(n)))},getActions:function(e){return s.get(c.getActions.expand(i.findParams(e)))},getPermissionSubjects:function(n){function s(){a++,2===a&&(c.resolve(i),a=0)}var i=[],a=0,c=r.defer();return d(n).success(function(r){e.forEach(r.item,function(r){var t={name:r.userName,role:""};e.extend(t,r),i.push(t)}),s()}).error(function(e,r,n,i){r!==t&&403!==r&&c.reject({data:e,status:r,headers:n,config:i}),s()}),f(n).success(function(r){e.forEach(r.item,function(r){var t={name:r.name,roleName:r.name,userName:""};e.extend(t,r),i.push(t)}),s()}).error(function(e,r,n,i){r!==t&&403!==r&&c.reject({data:e,status:r,headers:n,config:i}),s()}),c.promise.then(function(){return m(i,"name")})},create:function(e){return s.post(c.create.expand(),i.createParams(e)[a.modelPropertyName])},remove:function(e){var r=i.removeParams(e),t=e.actions[0],n=u(e.role)?"User":"Role";return s.delete(r[a.modelPropertyName].links("delete"+t.abrv+n).href)},createPermission:function(r,t,n){var s={dirty:!0,role:n.roleName,userName:n.userName,section:r,actions:[]};return e.forEach(t,function(r){var t={checked:!1};e.extend(t,r),s.actions.push(t)}),s},findPermission:function(e,r){for(var n=0;n<r.length;n++){var s=r[n];if(s.section===e.section&&(!u(s.role)&&!u(e.role)&&s.role===e.role||!u(s.userName)&&!u(e.userName)&&s.userName===e.userName))return s}return t},exists:function(e,r){return this.findPermission(e,r)!==t},togglePermission:function(r,t){var n={};e.extend(n,r),n.actions=[t];var s;return(s=t.checked?this.create:this.remove)(n)},getModulePermissions:function(e){var r={update:o.hasPermission(p(e)+".update"),create:o.hasPermission(p(e)+".create"),remove:o.hasPermission(p(e)+".delete"),read:o.hasPermission(p(e)+".read"),full:o.hasPermission(p(e)+".full")};return r},routeService:c}}])}(e,r),function(e,r,t){"use strict";r.service("baasicRecaptchaService",["recaptchaKey",function(r){var n=[];return{create:function(t,s){var i=t.attr("id");i||(i="recaptcha-"+1e4*Math.random(),t.attr("id",i));var a=grecaptcha.render(i,e.extend({sitekey:r},s));return n[a]=t,a},challenge:function(){return{}},response:function(r){var s;return r?s=grecaptcha.getResponse(r):e.forEach(n,function(e,r){r!==t&&(s=grecaptcha.getResponse(r))}),s},reload:function(r){var s;return r?s=grecaptcha.reset(r):e.forEach(n,function(e,r){r!==t&&(s=grecaptcha.reset(r))}),s},destroy:function(e){e&&delete n[e]}}}])}(e,r)}(angular);